<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Corporate Re-Styling | AI ìŠ¤íƒ€ì¼ ë³€í™˜ê¸°</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+KR:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: #f0f2f5; /* Instagram-like light background */
        }
        .app-card {
            max-width: 800px;
            min-height: 700px;
        }
        .image-container {
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            position: relative;
        }
        .image-placeholder, .image-display {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#405de6', /* A shade of Instagram blue/purple */
                        'accent': '#c13584', /* Pink/Red accent */
                        'button-bg': '#38a169', /* Green for action */
                    },
                }
            }
        }
    </script>
</head>
<body class="p-4 flex items-center justify-center">

    <div class="app-card bg-white rounded-3xl shadow-2xl p-6 sm:p-10 w-full">
        <header class="text-center mb-8 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-primary">ğŸ‘” AI ìŠ¤íƒ€ì¼ ë³€í™˜ê¸°</h1>
            <p class="text-gray-500 mt-2">ì–¼êµ´ì€ ìœ ì§€, ë°°ê²½ê³¼ ì˜ìƒë§Œ ë¹„ì¦ˆë‹ˆìŠ¤ ìºì£¼ì–¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- 1. Input Section -->
            <div class="flex flex-col items-center">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">1. ë‚´ ì‚¬ì§„ ì—…ë¡œë“œ</h2>
                
                <div class="image-container rounded-xl overflow-hidden mb-6 border-4 border-dashed border-gray-300 relative">
                    <img id="input-preview" class="image-display hidden" alt="ì—…ë¡œë“œëœ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°">
                    <div id="upload-placeholder" class="image-placeholder bg-gray-100 flex flex-col items-center justify-center p-4 text-gray-400 cursor-pointer hover:bg-gray-200 transition duration-200">
                        <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span class="text-center">í´ë¦­í•˜ì—¬ ì‚¬ì§„ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì„¸ìš”.</span>
                    </div>
                </div>

                <input type="file" id="image-upload" accept="image/*" class="hidden">
                <button id="upload-button" class="w-full sm:w-2/3 bg-primary text-white font-bold py-3 rounded-full shadow-lg hover:bg-blue-600 transition duration-300">
                    ì‚¬ì§„ ì„ íƒ
                </button>
            </div>

            <!-- 2. Output Section -->
            <div class="flex flex-col items-center">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">2. AI ë³€í™˜ ê²°ê³¼</h2>
                
                <div class="image-container rounded-xl overflow-hidden mb-6 border-4 border-gray-200 relative">
                    <img id="output-image" class="image-display hidden" alt="AI ë³€í™˜ ê²°ê³¼ ì´ë¯¸ì§€">
                    <div id="output-placeholder" class="image-placeholder bg-gray-100 flex flex-col items-center justify-center p-4 text-gray-400">
                        <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10l-2 2h20l-2-2V7M4 7a2 2 0 012-2h12a2 2 0 012 2M4 7a2 2 0 002 2h12a2 2 0 002-2"></path></svg>
                        <span class="text-center">ë³€í™˜ëœ ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="image-placeholder bg-black bg-opacity-70 flex flex-col items-center justify-center p-4 text-white hidden">
                        <div class="animate-spin inline-block w-10 h-10 border-4 border-white border-t-primary rounded-full" role="status"></div>
                        <p class="mt-4 font-medium">ìŠ¤íƒ€ì¼ ë³€í™˜ ì¤‘...</p>
                    </div>
                </div>

                <div class="flex space-x-4 w-full sm:w-2/3">
                    <button id="generate-button" disabled
                            class="flex-1 bg-accent text-white font-bold py-3 rounded-full shadow-lg transition duration-300 disabled:opacity-50 hover:bg-pink-700">
                        <span id="generate-text">AI ë³€í™˜ ì‹œì‘</span>
                    </button>
                    <button id="download-button" disabled
                            class="flex-1 bg-button-bg text-white font-bold py-3 rounded-full shadow-lg transition duration-300 disabled:opacity-50 hover:bg-green-700">
                        ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
                <p id="status-message" class="mt-4 text-sm text-center text-red-500 hidden"></p>
            </div>
        </main>
    </div>

    <script>
        // --- API & Model Configuration ---
        const apiKey = ""; 
        const modelName = 'gemini-2.5-flash-image-preview'; // Nano Banana alias
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        
        // --- DOM Elements ---
        const imageUpload = document.getElementById('image-upload');
        const uploadButton = document.getElementById('upload-button');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const inputPreview = document.getElementById('input-preview');
        const outputPlaceholder = document.getElementById('output-placeholder');
        const outputImage = document.getElementById('output-image');
        const generateButton = document.getElementById('generate-button');
        const downloadButton = document.getElementById('download-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const statusMessage = document.getElementById('status-message');

        let base64Image = null; // Holds the base64 string of the uploaded image
        let mimeType = null;    // Holds the mime type of the uploaded image

        // Target transformation prompt
        const prompt = "Redraw the person in the provided image, maintaining their facial features, hairstyle, and pose exactly, but change the background to a sophisticated and stylish IT startup office environment and change the clothing to clean business casual attire. The resulting image must be photorealistic and high resolution.";
        
        // --- Utility Functions ---

        /**
         * Converts a File object to a Base64 string and updates the preview.
         * @param {File} file 
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * Converts a data URL (e.g., 'data:image/jpeg;base64,...') to a pure base64 string.
         * @param {string} dataUrl 
         * @returns {string} Pure Base64 string.
         */
        function extractBase64(dataUrl) {
            return dataUrl.split(',')[1];
        }

        // --- Event Handlers ---

        // File selection logic
        uploadButton.addEventListener('click', () => imageUpload.click());
        uploadPlaceholder.addEventListener('click', () => imageUpload.click());

        imageUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                // 1. Convert and store base64 data
                const dataUrl = await fileToBase64(file);
                base64Image = extractBase64(dataUrl);
                mimeType = file.type;

                // 2. Update UI
                inputPreview.src = dataUrl;
                inputPreview.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                
                outputImage.classList.add('hidden');
                outputPlaceholder.classList.remove('hidden');
                downloadButton.disabled = true;
                
                // 3. Enable generate button
                generateButton.disabled = false;
                statusMessage.classList.add('hidden');

            } catch (error) {
                console.error("File processing error:", error);
                statusMessage.textContent = "íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì‹œë„í•´ ì£¼ì„¸ìš”.";
                statusMessage.classList.remove('hidden');
                base64Image = null;
                generateButton.disabled = true;
            }
        });

        // Image Generation Logic
        generateButton.addEventListener('click', generateImage);

        async function generateImage() {
            if (!base64Image) {
                statusMessage.textContent = "ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.";
                statusMessage.classList.remove('hidden');
                return;
            }

            // UI State: Loading
            loadingIndicator.classList.remove('hidden');
            outputPlaceholder.classList.add('hidden');
            generateButton.disabled = true;
            downloadButton.disabled = true;
            statusMessage.classList.add('hidden');

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64Image
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE']
                },
            };
            
            let maxRetries = 4;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         // Throw to retry or exit loop
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (base64Data) {
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        
                        // UI State: Success
                        outputImage.src = imageUrl;
                        outputImage.classList.remove('hidden');
                        loadingIndicator.classList.add('hidden');
                        generateButton.disabled = false;
                        downloadButton.disabled = false;
                        
                        break; // Success, exit loop
                    } else {
                        throw new Error('AI failed to generate a complete image.');
                    }
                } catch (error) {
                    console.error('Generation failed, retrying...', error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        // UI State: Final Failure
                        loadingIndicator.classList.add('hidden');
                        outputPlaceholder.classList.remove('hidden');
                        generateButton.disabled = false;
                        statusMessage.textContent = `ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì˜¤ë¥˜: ${error.message.substring(0, 50)}...) íŒŒì¼ì„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`;
                        statusMessage.classList.remove('hidden');
                    }
                }
            }
        }

        // Download Logic
        downloadButton.addEventListener('click', () => {
            const imageURL = outputImage.src;
            if (imageURL && !outputImage.classList.contains('hidden')) {
                const a = document.createElement('a');
                a.href = imageURL;
                a.download = 'ai_business_casual_style.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                statusMessage.textContent = "ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € AI ë³€í™˜ì„ ì‹œì‘í•˜ì„¸ìš”.";
                statusMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>